<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Agent Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #1C1C3C;
            color: #FFFFFF;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1, h2 {
            font-family: 'Montserrat', sans-serif;
            color: #935CFF;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            background-color: #333;
            border: 1px solid #CFCFD4;
            color: #FFFFFF;
            border-radius: 5px;
            font-size: 1rem;
        }
        button {
            background-color: #388BEB;
            color: #FFFFFF;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #935CFF;
        }
        textarea {
            width: 100%;
            height: 400px;
            background-color: #111;
            border: 1px solid #CFCFD4;
            color: #f0f0f0;
            font-family: Consolas, 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            border-radius: 5px;
        }
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #copy-button {
            background-color: #935CFF;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        #copy-button:hover {
            background-color: #388BEB;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Sales Agent Generator</h1>
        <p>This tool generates a personalized landing page and AI agent for a prospect.</p>
        
        <div class="form-group">
            <label for="target-url">Prospect's Website URL</label>
            <input type="text" id="target-url" placeholder="https://www.example.com">
        </div>

        <h2>API Keys (Saved in your browser)</h2>
        <div class="form-group">
            <label for="openrouter-key">OpenRouter API Key</label>
            <input type="password" id="openrouter-key">
        </div>
        <div class="form-group">
            <label for="elevenlabs-key">ElevenLabs API Key</label>
            <input type="password" id="elevenlabs-key">
        </div>
        <div class="form-group">
            <label for="elevenlabs-voice">ElevenLabs Voice ID</label>
            <input type="text" id="elevenlabs-voice" placeholder="Find this in your Voice Lab">
        </div>
        <div class="form-group">
            <label for="openrouter-model">OpenRouter Model Name</label>
            <input type="text" id="openrouter-model" value="google/gemini-pro">
        </div>

        <button id="generate-button">Generate PowerShell Script</button>

        <div class="output-header">
            <h2>Your `run.ps1` Script</h2>
            <button id="copy-button">Copy to Clipboard</button>
        </div>
        <textarea id="output-script" readonly placeholder="Your script will appear here..."></textarea>
    </div>

    <script>
        // --- AI: INJECT ANALYSIS DATA FROM PARTS 1-4 ---
        const analysis = {
            companyName: "[AI: Insert Company Name from Part 1]",
            systemPrompt: `[AI: Insert System Prompt from Part 4]`,
            landingPageHTML: `[AI: Insert Landing Page HTML from Part 4, escaped for a JS string]`
        };
        // --- END OF INJECTION ---

        // PowerShell Script Template
        const ps1Template = `
# --- Configuration ---
$COMPANY_NAME = "%%COMPANY_NAME%%"
$PROJECT_NAME = ($COMPANY_NAME.ToLower() -replace ' ', '-') + "-sales-agent"
$OPENROUTER_KEY = "%%OPENROUTER_KEY%%"
$ELEVENLABS_KEY = "%%ELEVENLABS_KEY%%"
$ELEVENLABS_VOICE = "%%ELEVENLABS_VOICE%%"
$OPENROUTER_MODEL = "%%OPENROUTER_MODEL%%"

Write-Host "--- Creating project $PROJECT_NAME ---"
New-Item -ItemType Directory -Name $PROJECT_NAME
Set-Location $PROJECT_NAME
New-Item -ItemType Directory -Name "public"

# --- File: package.json ---
Write-Host "Creating package.json..."
@"
{
  "name": "ai-sales-agent",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {"start": "node server.js"},
  "dependencies": {
    "express": "^4.19.2", "dotenv": "^16.4.5", "cors": "^2.8.5", "axios": "^1.7.2"
  }
}
"@ | Set-Content -Path "package.json" -Encoding utf8

# --- File: .env ---
# NOTE: We are creating .env directly since this is a one-off build.
Write-Host "Creating .env file with your keys..."
@"
OPENROUTER_API_KEY=$OPENROUTER_KEY
ELEVENLABS_API_KEY=$ELEVENLABS_KEY
OPENROUTER_MODEL_NAME=$OPENROUTER_MODEL
ELEVENLABS_VOICE_ID=$ELEVENLABS_VOICE
"@ | Set-Content -Path ".env" -Encoding utf8

# --- File: .gitignore ---
Write-Host "Creating .gitignore..."
@"
node_modules
.env
"@ | Set-Content -Path ".gitignore" -Encoding utf8

# --- File: server.js ---
Write-Host "Creating server.js..."
@"
const express = require('express');
const path = require('path');
const dotenv = require('dotenv');
const cors = require('cors');
const axios = require('axios');
dotenv.config();
const app = express();
const PORT = process.env.PORT || 3001;
const SYSTEM_PROMPT = \`%%SYSTEM_PROMPT%%\`;
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));
app.post('/chat', async (req, res) => {
  const { userMessage, chatHistory } = req.body;
  try {
    const llmResponse = await axios.post(
      'https://openrouter.ai/api/v1/chat/completions',
      { model: process.env.OPENROUTER_MODEL_NAME, messages: [{ role: 'system', content: SYSTEM_PROMPT }, ...chatHistory, { role: 'user', content: userMessage }] },
      { headers: { Authorization: \`Bearer \${process.env.OPENROUTER_API_KEY}\` } }
    );
    const textResponse = llmResponse.data.choices[0].message.content;
    const ttsResponse = await axios.post(
      \`https://api.elevenlabs.io/v1/text-to-speech/\${process.env.ELEVENLABS_VOICE_ID}/stream\`,
      { text: textResponse, model_id: 'eleven_multilingual_v2', voice_settings: { stability: 0.5, similarity_boost: 0.75 } },
      { headers: { 'Content-Type': 'application/json', 'xi-api-key': process.env.ELEVENLABS_API_KEY }, responseType: 'arraybuffer' }
    );
    const audioData = Buffer.from(ttsResponse.data).toString('base64');
    res.json({ textResponse, audioData: \`data:audio/mpeg;base64,\${audioData}\` });
  } catch (error) { console.error('Error in /chat endpoint:', error.message); res.status(500).json({ error: 'Failed to get AI response' }); }
});
app.get('*', (req, res) => { res.sendFile(path.join(__dirname, 'public', 'index.html')); });
app.listen(PORT, () => { console.log(\`Server running on http://localhost:\${PORT}\`); });
"@ | Set-Content -Path "server.js" -Encoding utf8

# --- File: public/index.html ---
Write-Host "Creating public/index.html (Personalized Landing Page)..."
@"
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A Better Way for $COMPANY_NAME</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  
  %%LANDING_PAGE_HTML%%

  <div class="chat-widget-container">
    <div id="chat-bubble" class="chat-bubble">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c.966 0 1.898-.19 2.774-.534a.75.75 0 0 0 .426-1.07 11.21 11.21 0 0 1-4.4-4.4.75.75 0 0 0-1.07-.426A9.75 9.75 0 0 0 3 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75Z" /></svg>
    </div>
    <div id="chat-window" class="chat-window">
      <div class="chat-header"><h3>Talk to our AI Assistant</h3><button id="close-chat">&times;</button></div>
      <div id="chat-messages" class="chat-messages"><div class="message ai-message">Hello! How can I help you learn about $COMPANY_NAME's services today?</div></div>
      <div class="chat-input-area"><input type="text" id="chat-input" placeholder="Ask about services or pricing..."><button id="send-button">Send</button></div>
    </div>
  </div>
  <script src="app.js"></script>
</body>
</html>
"@ | Set-Content -Path "public\index.html" -Encoding utf8

# --- File: public/style.css ---
Write-Host "Creating public/style.css..."
@"
/* --- AI: Injected Brand-Compliant Page Styles --- */
body { font-family: 'Lato', sans-serif; line-height: 1.6; background: #f4f7f6; color: #333; margin: 0; padding: 0; }
header { background: #1C1C3C; color: #FFFFFF; padding: 2rem 1rem; text-align: center; }
main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
section { background: #fff; border-radius: 8px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
h1 { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; }
h2 { font-family: 'Montserrat', sans-serif; font-size: 2rem; color: #1C1C3C; border-bottom: 2px solid #935CFF; padding-bottom: 0.5rem; }
h3 { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; color: #333; }
ul { list-style-type: none; padding-left: 0; }
section.analysis li { background: #fff8f8; border-left: 3px solid #e63946; padding: 0.5rem 1rem; margin-bottom: 0.5rem; font-style: italic; }
section.solution li { font-size: 1.1rem; margin-bottom: 0.5rem; }

/* --- AI: Injected Brand-Compliant Chat Widget Styles --- */
.chat-bubble { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #388BEB; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 9998; }
.chat-window { position: fixed; bottom: 100px; right: 20px; width: 350px; max-width: 90vw; height: 500px; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 9999; }
.chat-window.open { display: flex; }
.chat-header { background: #1C1C3C; color: #FFFFFF; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
.chat-header h3 { color: #FFFFFF; margin: 0; font-size: 1.1rem; font-family: 'Montserrat', sans-serif; }
#close-chat { background: none; border: none; color: #CFCFD4; font-size: 1.5rem; cursor: pointer; }
.chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
.message { padding: 0.75rem 1rem; border-radius: 18px; max-width: 80%; line-height: 1.4; }
.ai-message { background: #f1f0f0; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }
.user-message { background: #388BEB; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
.chat-input-area { display: flex; border-top: 1px solid #ddd; padding: 0.5rem; }
#chat-input { flex-grow: 1; border: none; padding: 0.75rem; border-radius: 20px; background: #f1f0f0; outline: none; }
#send-button { background: #388BEB; color: white; border: none; padding: 0 1rem; margin-left: 0.5rem; border-radius: 20px; cursor: pointer; }
.audio-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
.play-audio-btn { background: #f1f0f0; border: 1px solid #ddd; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
"@ | Set-Content -Path "public\style.css" -Encoding utf8

# --- File: public/app.js ---
Write-Host "Creating public/app.js..."
@"
document.addEventListener('DOMContentLoaded', () => {
  const chatBubble = document.getElementById('chat-bubble');
  const chatWindow = document.getElementById('chat-window');
  const closeChat = document.getElementById('close-chat');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');
  const chatMessages = document.getElementById('chat-messages');
  let chatHistory = []; let currentAudio = null;
  chatBubble.addEventListener('click', () => chatWindow.classList.toggle('open'));
  closeChat.addEventListener('click', () => chatWindow.classList.remove('open'));
  sendButton.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
  async function sendMessage() {
    const userMessage = chatInput.value.trim(); if (!userMessage) return;
    addMessageToUI(userMessage, 'user'); chatInput.value = '';
    chatHistory.push({ role: 'user', content: userMessage });
    const loadingEl = addMessageToUI('...', 'loading');
    try {
      const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userMessage, chatHistory }) });
      if (!response.ok) throw new Error('Network response was not ok');
      const { textResponse, audioData } = await response.json();
      chatMessages.removeChild(loadingEl);
      addMessageToUI(textResponse, 'ai', audioData);
      chatHistory.push({ role: 'assistant', content: textResponse });
      playAudio(audioData);
    } catch (error) { console.error('Error:', error); chatMessages.removeChild(loadingEl); addMessageToUI('Sorry, I am having trouble. Please try again.', 'ai'); }
  }
  function addMessageToUI(message, sender, audioData = null) {
    const messageEl = document.createElement('div');
    messageEl.classList.add('message', \`\${sender}-message\`);
    messageEl.textContent = (sender === 'loading') ? '...' : message;
    if (sender === 'ai' && audioData) {
      const playBtn = document.createElement('button');
      playBtn.classList.add('play-audio-btn');
      playBtn.innerHTML = \`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L8.029 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" /></svg>\`;
      playBtn.onclick = () => playAudio(audioData);
      const audioControls = document.createElement('div');
      audioControls.classList.add('audio-controls');
      audioControls.appendChild(playBtn);
      messageEl.appendChild(audioControls);
    }
    chatMessages.appendChild(messageEl); chatMessages.scrollTop = chatMessages.scrollHeight; return messageEl;
  }
  function playAudio(audioData) { if (currentAudio) currentAudio.pause(); currentAudio = new Audio(audioData); currentAudio.play(); }
});
"@ | Set-Content -Path "public\app.js" -Encoding utf8

# --- Final Steps: Git & GitHub ---
Write-Host "--- Initializing Git and Pushing to GitHub ---"
Write-Host "Note: This requires Node.js, npm, git, and the GitHub CLI ('gh') to be installed and in your PATH."
Write-Host "Running npm install..."
npm install
Write-Host "Initializing Git repository..."
git init
git add .
git commit -m "Initial commit: AI-generated sales agent for $COMPANY_NAME"
Write-Host "Creating GitHub repo '$PROJECT_NAME' and pushing..."
gh repo create "$PROJECT_NAME" --public --source=. --push
Write-Host "--- All Done! ---"
Write-Host "Project created in: $(Get-Location)"
Write-Host "Pushed to GitHub: https://github.com/$(gh auth status -h github.com -u)/$PROJECT_NAME"
Write-Host "To run locally:"
Write-Host "1. cd $PROJECT_NAME"
Write-Host "2. (Keys are already in .env) npm start"
Write-Host "3. Open http://localhost:3001"
`;

        // --- GUI JavaScript Logic ---

        // Load saved keys from localStorage
        document.getElementById('openrouter-key').value = localStorage.getItem('openrouter-key') || '';
        document.getElementById('elevenlabs-key').value = localStorage.getItem('elevenlabs-key') || '';
        document.getElementById('elevenlabs-voice').value = localStorage.getItem('elevenlabs-voice') || '';
        document.getElementById('openrouter-model').value = localStorage.getItem('openrouter-model') || 'google/gemini-pro';

        // Generate Script Button
        document.getElementById('generate-button').addEventListener('click', () => {
            // Save keys to localStorage
            localStorage.setItem('openrouter-key', document.getElementById('openrouter-key').value);
            localStorage.setItem('elevenlabs-key', document.getElementById('elevenlabs-key').value);
            localStorage.setItem('elevenlabs-voice', document.getElementById('elevenlabs-voice').value);
            localStorage.setItem('openrouter-model', document.getElementById('openrouter-model').value);

            // Get values from form
            const targetUrl = document.getElementById('target-url').value;
            const openRouterKey = document.getElementById('openrouter-key').value;
            const elevenLabsKey = document.getElementById('elevenlabs-key').value;
            const elevenLabsVoice = document.getElementById('elevenlabs-voice').value;
            const openRouterModel = document.getElementById('openrouter-model').value;

            if (!targetUrl || !openRouterKey || !elevenLabsKey || !elevenLabsVoice) {
                alert('Please fill in all fields.');
                return;
            }

            // --- Dynamic Replacements ---
            let finalScript = ps1Template;

            // Simple replacements
            finalScript = finalScript.replace(/%%COMPANY_NAME%%/g, analysis.companyName);
            finalScript = finalScript.replace(/%%OPENROUTER_KEY%%/g, openRouterKey);
            finalScript = finalScript.replace(/%%ELEVENLABS_KEY%%/g, elevenLabsKey);
            finalScript = finalScript.replace(/%%ELEVENLABS_VOICE%%/g, elevenLabsVoice);
            finalScript = finalScript.replace(/%%OPENROUTER_MODEL%%/g, openRouterModel);

            // Escaped content replacements
            // (PowerShell/CMD escaping is tricky, so we inject into a JS-style template literal)
            finalScript = finalScript.replace('%%SYSTEM_PROMPT%%', analysis.systemPrompt.replace(/`/g, '\\`'));
            finalScript = finalScript.replace('%%LANDING_PAGE_HTML%%', analysis.landingPageHTML.replace(/`/g, '\\`'));
            
            document.getElementById('output-script').value = finalScript;
            alert('Script Generated! Ready to copy.');
        });

        // Copy to Clipboard Button
        document.getElementById('copy-button').addEventListener('click', () => {
            const outputScript = document.getElementById('output-script');
            if (!outputScript.value) {
                alert('Please generate a script first.');
                return;
            }
            outputScript.select();
            document.execCommand('copy');
            alert('Script copied to clipboard!');
        });
    </script>
</body>
</html>